name: CI/CD Pipeline

on:
  push:
    branches: [ develop, main ]
  pull_request:
    branches: [ develop, main ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # CONTINUOUS INTEGRATION JOBS
  # ============================================================================
  
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install backend dependencies
      run: |
        cd src/backend
        npm ci
    
    - name: Create .env file
      run: |
        cd src/backend
        cat > .env << EOF
        NODE_ENV=test
        PORT=5000
        MONGODB_URI=mongodb://localhost:27017/mdp_test
        JWT_SECRET=test_jwt_secret_key_for_ci
        JWT_EXPIRE=24h
        EMAIL_HOST=smtp.example.com
        EMAIL_PORT=587
        EMAIL_USER=test@example.com
        EMAIL_PASS=test_password
        EMAIL_FROM=noreply@example.com
        RATE_LIMIT_WINDOW_MS=900000
        RATE_LIMIT_MAX_REQUESTS=100
        EOF
    
    - name: Wait for MongoDB
      run: |
        timeout 30 bash -c 'until nc -z localhost 27017; do sleep 1; done'
    
    - name: Start backend server
      run: |
        cd src/backend
        npm start &
        echo $! > server.pid
    
    - name: Wait for server to be ready
      run: |
        timeout 30 bash -c 'until nc -z localhost 5000; do sleep 1; done' || echo "Server may not be ready"
        sleep 2
    
    - name: Run backend tests
      run: |
        cd src/backend
        npm run test-auth
        npm run test-donate
        npm run verify-story-2.3
        npm run test-story-4.1
        npm run test-story-5.4
        npm run test-story-5.5
    
    - name: Stop backend server
      if: always()
      run: |
        cd src/backend
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi
      env:
        MONGODB_URI: mongodb://localhost:27017/mdp_test
        JWT_SECRET: test_jwt_secret_key_for_ci
    
    - name: Check for code quality issues
      run: |
        cd src/backend
        echo "Running basic code checks..."
        node -c server.js
        node -c server-https.js
        find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;

  lint:
    name: Lint & Code Quality
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd src/backend
        npm ci
    
    - name: Check code syntax
      run: |
        cd src/backend
        find . -name "*.js" -not -path "./node_modules/*" -exec node -c {} \;
    
    - name: Check code formatting
      run: |
        cd src/backend
        echo "Checking JavaScript files..."
        find . -name "*.js" -not -path "./node_modules/*" | wc -l
    
    - name: Check for TODO comments
      run: |
        echo "## TODO Comments Found" >> $GITHUB_STEP_SUMMARY
        grep -r "TODO\|FIXME\|XXX" --include="*.js" --exclude-dir=node_modules . || echo "No TODO comments found" >> $GITHUB_STEP_SUMMARY
    
    - name: Code metrics
      run: |
        echo "## Code Metrics" >> $GITHUB_STEP_SUMMARY
        echo "### Backend Files" >> $GITHUB_STEP_SUMMARY
        echo "- JavaScript files: $(find src/backend -name '*.js' -not -path '*/node_modules/*' | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "- Total lines: $(find src/backend -name '*.js' -not -path '*/node_modules/*' -exec cat {} \; | wc -l)" >> $GITHUB_STEP_SUMMARY
    
    - name: Dependency check
      run: |
        cd src/backend
        echo "## Dependencies" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        npm list --depth=0 >> $GITHUB_STEP_SUMMARY || true
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run npm audit
      run: |
        cd src/backend
        npm audit --audit-level=high || true
    
    - name: Check for secrets
      run: |
        echo "Checking for exposed secrets..."
        if grep -r "password\s*=\s*['\"].*['\"]" --include="*.js" --exclude-dir=node_modules .; then
          echo "Error: Potential hardcoded passwords found"
          exit 1
        fi
        echo "No hardcoded secrets detected"

  build-check:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test-backend, lint, security-scan]
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd src/backend
        npm ci
    
    - name: Verify build integrity
      run: |
        cd src/backend
        echo "Build check completed successfully"
        echo "All dependencies installed"
        npm list --depth=0

  # ============================================================================
  # CONTINUOUS DEPLOYMENT JOBS
  # ============================================================================

  deploy-production:
    name: Production Deployment
    runs-on: ubuntu-latest
    needs: [build-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Install dependencies
      run: |
        cd src/backend
        npm ci --production
    
    - name: Create deployment package
      run: |
        cd src/backend
        tar -czf ../../deployment-package.tar.gz \
          --exclude='node_modules' \
          --exclude='*.log' \
          --exclude='.env' \
          .
    
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: production-deployment-package
        path: deployment-package.tar.gz
        retention-days: 90
    
    - name: Production deployment summary
      run: |
        echo "## ðŸš€ Production Deployment Package Created" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Author: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Timestamp: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Ready for production deployment!" >> $GITHUB_STEP_SUMMARY
